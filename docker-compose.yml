version: '3.8'

services:
  # Git MCP: Repo ops on mounted projects
  mcp-git:
    image: ghcr.io/modelcontextprotocol/servers:v0.1.0  # Official; fallback to build if needed
    container_name: mcp-git
    stdin_open: true
    tty: true
    volumes:
      - ${PROJECTS_PATH:-/pub/your-repo}:/projects:ro
    ports:
      - "${GIT_PORT:-8001}:8001"
    command: ["mcp-server-git", "--transport", "http", "--host", "0.0.0.0", "--port", "8001", "--repository", "/projects"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcp-net

  # Web Search MCP: Self-hosted SearXNG (no API key)
  mcp-web:
    image: sebp/omegasearch:latest
    container_name: mcp-web
    environment:
      - SEARXNG_BASE_URL=http://localhost:8002
      - UWSGI_WORKERS=2
    ports:
      - "${WEB_PORT:-8002}:8080"
    volumes:
      - ./searxng-settings.yml:/etc/searxng/settings.yml:ro  # Optional config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcp-net

  # Local Library MCP: Filesystem + PDF extraction
  mcp-lib:
    image: python:3.12-slim
    container_name: mcp-lib
    volumes:
      - ${LIBRARY_PATH:-/pub/ebooks}:/ebooks:ro
      - ./pdf_server.py:/app/pdf_server.py:ro  # Add this file for extraction
    working_dir: /app
    command: ["python", "pdf_server.py", "--transport", "http", "--host", "0.0.0.0", "--port", "8003", "--allowed-paths", "/ebooks"]
    ports:
      - "${LIB_PORT:-8003}:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcp-net

networks:
  mcp-net:
    driver: bridge
